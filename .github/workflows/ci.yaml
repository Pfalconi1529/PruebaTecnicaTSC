# Define el nombre del flujo de trabajo (Workflow)
name: CI / Build & Deploy

# Define los eventos que dispararán este flujo de trabajo
on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

# Define el conjunto de trabajos (Jobs) a ejecutar
jobs:
  build-and-push: # Se renombra el job para reflejar que ya no hay tests
    # Ejecuta el trabajo en el último entorno de Ubuntu
    runs-on: ubuntu-latest
    
    # Define los pasos
    steps:
      - name: Checkout Code
        # Obtiene el código del repositorio
        uses: actions/checkout@v4

      - name: Setup Node.js Environment
        # Configura el entorno de Node.js (v20 recomendado)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' # Habilita el caché de dependencias de npm

      - name: Install Dependencies
        # Instala las dependencias del proyecto
        run: npm install

      - name: Build TypeScript Project
        # Compila el código para asegurar que no haya errores de TS
        run: npm run build
        
      # ===============================================
      # CONSTRUCCIÓN Y PUSH DE LA IMAGEN DE DOCKER
      # ===============================================

      - name: Set up Docker Buildx
        # Configura Docker Buildx para construir imágenes de manera eficiente
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        # 🔑 Inicia sesión en Docker Hub (necesitas configurar secretos en GitHub)
        # Los secretos DOCKER_USERNAME y DOCKER_PASSWORD deben configurarse en el repositorio.
        if: github.ref == 'refs/heads/main' # Solo iniciar sesión y subir en el branch principal
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        # Construye la imagen usando el Dockerfile y la sube a Docker Hub.
        if: github.ref == 'refs/heads/main' # Solo subir en el branch principal
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/devops-node-api:latest # Etiqueta con 'latest'
          cache-from: type=gha
          cache-to: type=gha,mode=max
