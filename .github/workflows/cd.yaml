name: CI/CD completo EKS + Docker

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      DOCKER_REPO: pfalck/devopstest
      IMAGE_TAG: latest
      CLUSTER_NAME: my-cluster
      AWS_REGION: us-east-1

    steps:
      # 1️⃣ Checkout del repositorio
      - name: Checkout
        uses: actions/checkout@v3

      # 2️⃣ Configurar AWS CLI
      - name: Configurar AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3️⃣ Crear clúster EKS (si no existe)
      - name: Crear clúster EKS
        run: |
          if ! aws eks describe-cluster --name $CLUSTER_NAME >/dev/null 2>&1; then
            echo "Creando clúster EKS..."
            aws eks create-cluster \
              --name $CLUSTER_NAME \
              --region $AWS_REGION \
              --role-arn ${{ secrets.EKS_CLUSTER_ROLE_ARN }} \
              --resources-vpc-config subnetIds=${{ secrets.SUBNET_IDS }},securityGroupIds=${{ secrets.SECURITY_GROUP_IDS }}
            aws eks wait cluster-active --name $CLUSTER_NAME
          else
            echo "Clúster ya existe, saltando creación"
          fi

      # 4️⃣ Configurar kubectl para apuntar al clúster
      - name: Configurar kubectl
        run: |
          aws eks update-kubeconfig --name $CLUSTER_NAME --region $AWS_REGION

      # 5️⃣ Construir Docker image
      - name: Build Docker image
        run: |
          docker build -t $DOCKER_REPO:$IMAGE_TAG .

      # 6️⃣ Login en Docker Hub
      - name: Login Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 7️⃣ Push Docker image
      - name: Push Docker image
        run: |
          docker push $DOCKER_REPO:$IMAGE_TAG

      # 8️⃣ Deploy en EKS usando kubectl
      - name: Deploy en EKS
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl rollout status deployment/my-app-deployment
